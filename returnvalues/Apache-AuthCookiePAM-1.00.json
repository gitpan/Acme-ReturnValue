[
   {
      "PPI" : "PPI::Statement::Sub",
      "bad" : "sub changepwd ($$) \n{\n  my ($self, $r) ;\n  ($self, $r) = @_;\n  \n  my $debug; $debug = $r->dir_config(\"AuthCookieDebug\") || 0;\n\n  my ($auth_type, $auth_name);  \n  ($auth_type, $auth_name) = ($r->auth_type, $r->auth_name);\n\n  my %args; %args = $r->method eq 'POST' ? $r->content : $r->args;\n\n  $self->_convert_to_get($r, \\%args) if $r->method eq 'POST';\n\n  unless (exists $args{'destination'}) {\n    $r->log_error(\"No key 'destination' found in form data\");\n    $r->subprocess_env('AuthenReason', 'no_cookie');\n    return $auth_type->login_form;\n  }\n  $r->subprocess_env('AuthenReason', 'Password Change requested/required');\n  \n  my @credentials;\n  my $user; $user = $args{\"credential_0\"};\n  $user=~ tr/A-Z/a-z/;\n  unless ( $user =~ /^.+$/ ) {\n\t$r->log_reason( \"Apache::AuthCookiePAM: no username supplied for auth realm $auth_name\", $r->uri );\n  }\n  my $oldpassword; $oldpassword = $args{\"credential_1\"};\n  unless ( $oldpassword =~ /^.+$/ ) {\n\t$r->log_reason( \"Apache::AuthCookiePAM: no password supplied \", $r->uri );\n  }\n  my $newpassword ; $newpassword = $args{\"credential_2\"};\n  unless ( $newpassword =~ /^.+$/ ) {\n\t$r->log_reason( \"Apache::AuthCookiePAM: no password supplied \", $r->uri );\n  }\n  my $confirmpassword; $confirmpassword = $args{\"credential_3\"};\n  unless ( $confirmpassword =~ /^.+$/  ) {\n\t$r->log_reason( \"Apache::AuthCookiePAM: passwords don't match\", $r->uri );\n  }\n  \n  my ($pamh,$res);\n  my $funcref;\n  $funcref=create_conv_func($r,$user,$oldpassword,$newpassword,$confirmpassword);\n\t\t\t\t\t\t\t\t\t  \n  my %c; %c = _config_vars $r;\n\n  my $service; $service = $c{PAM_service};\n  ref($pamh = new Authen::PAM($service, $user,$funcref)) || die \"Error code $pamh during PAM init!\";\n  $res = $pamh->pam_chauthtok();\n  $pamh=0;\n  undef $pamh;\n\n  if ( $res == PAM_SUCCESS()) {\n       $r->subprocess_env('AuthenReason', 'Password Updated. Please login with your new password');\n       $r->log_reason(\"AuthenCookiePAM:\". $args{'destination'}.\"Password for $user Updated. Please login with your new password\");\n       $auth_type->logout($r);\n       $r->err_header_out(\"Location\" => $args{'destination'});\n       return REDIRECT;\n  }\n  else { \n       $r->subprocess_env('AuthenReason', \"Password Not Updated. New password did not satisfy specified rules or failed authentication\");\n       $r->log_reason(\"AuthenCookiePAM: Password for $user Not Updated. \");\n       return $auth_type->changepwd_form($user);\n    }\n}",
      "file" : "/var/tmp/arv_pChP29/Apache-AuthCookiePAM-1.00/AuthCookiePAM.pm",
      "package" : "Apache::AuthCookiePAM"
   }
]
